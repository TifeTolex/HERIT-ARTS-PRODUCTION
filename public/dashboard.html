<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Content Ads</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body data-page="brand-dashboard" data-theme="dark">
  <header>
    <nav class="container">
      <div class="logo">
        <img src="assets/logo-placeholder.svg" alt="H'ARTs Studio Logo" width="32" height="32" />
        <span>H'ARTs STUDIO</span>
      </div>

      <!-- Hamburger toggle -->
      <div class="menu-toggle" id="menuToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>

      <div class="nav-links" id="navLinks">
        <a href="dashboard.html" aria-current="page">Dashboard</a>
        <a href="projects.html">Projects</a>
        <a href="team.html">Team</a>
        <a href="subscriptions.html">Subscriptions</a>
        <button class="btn ghost" id="logoutBtn">Logout</button>
      </div>
    </nav>
  </header>

  <main id="main" class="container">
    <h1>Dashboard</h1>

    <!-- KPI Section -->
    <section class="grid cols-3 mt-2" id="kpis">
      <div class="card kpi">
        <svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" stroke-dasharray="170" stroke-dashoffset="40" /></svg>
        <div>Active projects</div>
        <div class="num" id="kpiActive">0</div>
      </div>
      <div class="card kpi">
        <svg viewBox="0 0 64 64"><rect x="12" y="12" width="40" height="40" rx="8" stroke-dasharray="140" stroke-dashoffset="20" /></svg>
        <div>Queued</div>
        <div class="num" id="kpiQueued">0</div>
      </div>
      <div class="card kpi">
        <svg viewBox="0 0 64 64"><path d="M16 32l10 10 22-22" stroke-dasharray="60" stroke-dashoffset="0" /></svg>
        <div>Completed</div>
        <div class="num" id="kpiCompleted">0</div>
      </div>
    </section>

    <!-- Project List -->
    <section class="mt-3 fade-in">
      <h2>Your projects</h2>
      <div id="projectList" class="grid"></div>
      <a class="btn mt-2" href="projects.html">Create new project</a>
    </section>

    <!-- Notifications -->
    <section class="mt-3 card fade-in">
      <h2>Notifications</h2>
      <ul id="notifications" class="unstyled"></ul>
    </section>
  </main>

  <script type="module">
    import { api, requireAuthOrRedirect, logout, showToast, checkTrial } from '/js/utils.js';
    document.addEventListener('DOMContentLoaded', () => {
      requireAuthOrRedirect();
      checkTrial();
    });
    document.getElementById("logoutBtn").addEventListener("click", logout);

    (async () => {
      try {
        const { projects } = await api('/api/projects');
        const active = projects.filter(p => p.status !== 'Completed').length;
        const queued = projects.filter(p => p.status === 'Pending').length;
        const completed = projects.filter(p => p.status === 'Completed').length;

        document.getElementById('kpiActive').textContent = active;
        document.getElementById('kpiQueued').textContent = queued;
        document.getElementById('kpiCompleted').textContent = completed;

        const list = document.getElementById('projectList');
        if (projects.length === 0) {
          list.innerHTML = '<div class="text-muted">No projects yet. Create your first project.</div>';
        } else {
          list.classList.add('grid','cols-2');
          list.innerHTML = projects.map(p => `
            <article class="card fade-in">
              <h3>${p.name || 'Untitled project'}</h3>
              <div class="text-muted">Created: ${new Date(p.createdAt || Date.now()).toLocaleString()}</div>
              <div>Status: <span class="status ${String(p.status||'Pending').replace(/\s+/g,'')}">${p.status||'Pending'}</span></div>
              <a class="btn mt-1" href="review.html?id=${encodeURIComponent(p.id)}">Open</a>
            </article>
          `).join('');
        }

        const notif = document.getElementById('notifications');
        const now = new Date();
        const statusUpdates = projects.flatMap(p => {
          const notes = [];
          if (['Delivered','Completed'].includes(p.status)) {
            notes.push(`Project <strong>${p.name || 'Untitled'}</strong> is now <em>${p.status}</em>.`);
          }
          if (p.assignee) {
            notes.push(`Project <strong>${p.name || 'Untitled'}</strong> has been assigned to <em>${p.assignee}</em>.`);
          }
          if (p.deadline) {
            const deadline = new Date(p.deadline);
            const diffDays = Math.ceil((deadline - now) / (1000*60*60*24));
            if (diffDays > 0 && diffDays <= 2) {
              notes.push(`⏰ Deadline for <strong>${p.name || 'Untitled'}</strong> is in ${diffDays} day(s).`);
            }
          }
          return notes;
        });

        notif.innerHTML = statusUpdates.length
          ? statusUpdates.map(n => `<li>${n}</li>`).join('')
          : '<li class="text-muted">No notifications</li>';
      } catch (err) {
        console.error('Failed to load dashboard', err);
      }
    })();
  </script>

     <script>
  const menuToggle = document.getElementById('menuToggle');
  const navLinks = document.getElementById('navLinks');

  menuToggle.addEventListener('click', () => {
    menuToggle.classList.toggle('active');
    navLinks.classList.toggle('active');
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!menuToggle.contains(e.target) && !navLinks.contains(e.target)) {
      menuToggle.classList.remove('active');
      navLinks.classList.remove('active');
    }
  });
</script>
</body>
</html>
